<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AWINLY Admin Panel</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dnd/16.0.1/index.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dnd-html5-backend/16.0.1/index.umd.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/javascript">
    'use strict';
    console.log('admin.js starting at', new Date().toISOString());
    const { useState, useEffect, useRef } = React;
    const { DndProvider, useDrag, useDrop } = ReactDnD;
    const { HTML5Backend } = ReactDnDHTML5Backend;
    const h = React.createElement;
    // Cloudinary configuration
    const CLOUD_NAME = 'dkjakynhh';
    const API_KEY = '724711754654635';
    const API_SECRET = 'v4vizym6WCttYT-13k5XXw7yps8';
    // Translations
    const translations = {
      EN: {
        admin_title: "AWINLY Admin Panel",
        add_property: "Add Property",
        update_property: "Update Property",
        existing_properties: "Existing Properties",
        no_properties: "No properties found.",
        edit: "Edit",
        delete: "Delete",
        title_en: "Title (English)",
        title_zh: "Title (Chinese)",
        city: "City",
        select_city: "Select City",
        deal_type: "Deal Type",
        property_type: "Property Type",
        price_cny: "Price CNY",
        price_usd: "Price USD",
        area: "Area (m²)",
        floor: "Floor",
        rooms: "Rooms",
        year_built: "Year Built",
        realtor_name: "Realtor Name",
        realtor_email: "Realtor Email",
        realtor_phone: "Realtor Phone",
        description_en: "Description (English)",
        description_zh: "Description (Chinese)",
        upload_images: "Upload Images",
        remove_image: "Remove Image",
        required_fields: "Please fill in all required fields (Title, City, Price CNY, Price USD).",
        invalid_email: "Please enter a valid realtor email or 'N/A'.",
        confirm_delete: "Are you sure you want to delete this property?",
        property_added: "Property added successfully!",
        property_updated: "Property updated successfully!",
        property_deleted: "Property deleted successfully!",
        upload_error: "Image upload failed",
        cloudinary_error: "Cloudinary upload failed. Check console for details.",
        language: "Language",
        buy: "Buy",
        rent: "Rent",
        Apartment: "Apartment",
        House: "House",
        Land: "Land",
        Anqing: "Anqing",
        Baoding: "Baoding",
        Beijing: "Beijing",
        Bengbu: "Bengbu",
        Binzhou: "Binzhou",
        Cangzhou: "Cangzhou",
        Changchun: "Changchun",
        Changsha: "Changsha",
        Changzhou: "Changzhou",
        Chengde: "Chengde",
        Chengdu: "Chengdu",
        Chizhou: "Chizhou",
        Chongqing: "Chongqing",
        Chuzhou: "Chuzhou",
        Dalian: "Dalian",
        Dezhou: "Dezhou",
        Dongying: "Dongying",
        Fuyang: "Fuyang",
        Fuzhou: "Fuzhou",
        Guangzhou: "Guangzhou",
        Guiyang: "Guiyang",
        Haikou: "Haikou",
        Handan: "Handan",
        Hangzhou: "Hangzhou",
        Harbin: "Harbin",
        Hefei: "Hefei",
        Hengshui: "Hengshui",
        Heze: "Heze",
        Hohhot: "Hohhot",
        HuaiAn: "Huai'an",
        Huaibei: "Huaibei",
        Huainan: "Huainan",
        Huangshan: "Huangshan",
        Huzhou: "Huzhou",
        Jiaxing: "Jiaxing",
        Jinan: "Jinan",
        Jinhua: "Jinhua",
        Kunming: "Kunming",
        Laiwu: "Laiwu",
        Langfang: "Langfang",
        Lanzhou: "Lanzhou",
        Lhasa: "Lhasa",
        Lianyungang: "Lianyungang",
        Liaocheng: "Liaocheng",
        Linyi: "Linyi",
        Lishui: "Lishui",
        LuAn: "Lu'an",
        MaAnshan: "Ma'anshan",
        Nanchang: "Nanchang",
        Nanjing: "Nanjing",
        Nanning: "Nanning",
        Ningbo: "Ningbo",
        Qingdao: "Qingdao",
        Qinhuangdao: "Qinhuangdao",
        Quzhou: "Quzhou",
        Rizhao: "Rizhao",
        Shanghai: "Shanghai",
        Shaoxing: "Shaoxing",
        Shenyang: "Shenyang",
        Shenzhen: "Shenzhen",
        Shijiazhuang: "Shijiazhuang",
        Suqian: "Suqian",
        Suzhou: "Suzhou",
        Taiyuan: "Taiyuan",
        Taizhou: "Taizhou",
        Tangshan: "Tangshan",
        Tianjin: "Tianjin",
        Tongling: "Tongling",
        Urumqi: "Urumqi",
        Weifang: "Weifang",
        Weihai: "Weihai",
        Wenzhou: "Wenzhou",
        Wuhan: "Wuhan",
        Wuxi: "Wuxi",
        XiAn: "Xi'an",
        Xiamen: "Xiamen",
        Xingtai: "Xingtai",
        Xining: "Xining",
        Xuancheng: "Xuancheng",
        Yancheng: "Yancheng",
        Yangzhou: "Yangzhou",
        Yantai: "Yantai",
        Yinchuan: "Yinchuan",
        Zaozhuang: "Zaozhuang",
        Zhangjiakou: "Zhangjiakou",
        Zhengding: "Zhengding",
        Zhengzhou: "Zhengzhou",
        Zhenjiang: "Zhenjiang",
        Zhoushan: "Zhoushan",
        Zibo: "Zibo"
      },
      zh: {
        admin_title: "AWINLY 管理面板",
        add_property: "添加物业",
        update_property: "更新物业",
        existing_properties: "现有物业",
        no_properties: "未找到物业。",
        edit: "编辑",
        delete: "删除",
        title_en: "标题 (英文)",
        title_zh: "标题 (中文)",
        city: "城市",
        select_city: "选择城市",
        deal_type: "交易类型",
        property_type: "物业类型",
        price_cny: "人民币价格",
        price_usd: "美元价格",
        area: "面积（平方米）",
        floor: "楼层",
        rooms: "房间",
        year_built: "建造年份",
        realtor_name: "经纪人姓名",
        realtor_email: "经纪人邮箱",
        realtor_phone: "经纪人电话",
        description_en: "描述（英文)",
        description_zh: "描述（中文)",
        upload_images: "上传图片",
        remove_image: "删除图片",
        required_fields: "请填写所有必填字段（标题、城市、人民币价格、美元价格）。",
        invalid_email: "请输入有效的经纪人邮箱或 'N/A'。",
        confirm_delete: "您确定要删除此物业吗？",
        property_added: "物业添加成功！",
        property_updated: "物业更新成功！",
        property_deleted: "物业删除成功！",
        upload_error: "图片上传失败",
        cloudinary_error: "Cloudinary 上传失败。请检查控制台详情。",
        language: "语言",
        buy: "购买",
        rent: "租赁",
        Apartment: "公寓",
        House: "别墅",
        Land: "土地",
        Anqing: "安庆",
        Baoding: "保定",
        Beijing: "北京",
        Bengbu: "蚌埠",
        Binzhou: "滨州",
        Cangzhou: "沧州",
        Changchun: "长春",
        Changsha: "长沙",
        Changzhou: "常州",
        Chengde: "承德",
        Chengdu: "成都",
        Chizhou: "池州",
        Chongqing: "重庆",
        Chuzhou: "滁州",
        Dalian: "大连",
        Dezhou: "德州",
        Dongying: "东营",
        Fuyang: "阜阳",
        Fuzhou: "福州",
        Guangzhou: "广州",
        Guiyang: "贵阳",
        Haikou: "海口",
        Handan: "邯郸",
        Hangzhou: "杭州",
        Harbin: "哈尔滨",
        Hefei: "合肥",
        Hengshui: "衡水",
        Heze: "菏泽",
        Hohhot: "呼和浩特",
        HuaiAn: "淮安",
        Huaibei: "淮北",
        Huainan: "淮南",
        Huangshan: "黄山",
        Huzhou: "湖州",
        Jiaxing: "嘉兴",
        Jinan: "济南",
        Jinhua: "金华",
        Kunming: "昆明",
        Laiwu: "莱芜",
        Langfang: "廊坊",
        Lanzhou: "兰州",
        Lhasa: "拉萨",
        Lianyungang: "连云港",
        Liaocheng: "聊城",
        Linyi: "临沂",
        Lishui: "丽水",
        LuAn: "六安",
        MaAnshan: "马鞍山",
        Nanchang: "南昌",
        Nanjing: "南京",
        Nanning: "南宁",
        Ningbo: "宁波",
        Qingdao: "青岛",
        Qinhuangdao: "秦皇岛",
        Quzhou: "衢州",
        Rizhao: "日照",
        Shanghai: "上海",
        Shaoxing: "绍兴",
        Shenyang: "沈阳",
        Shenzhen: "深圳",
        Shijiazhuang: "石家庄",
        Suqian: "宿迁",
        Suzhou: "苏州",
        Taiyuan: "太原",
        Taizhou: "台州",
        Tangshan: "唐山",
        Tianjin: "天津",
        Tongling: "铜陵",
        Urumqi: "乌鲁木齐",
        Weifang: "潍坊",
        Weihai: "威海",
        Wenzhou: "温州",
        Wuhan: "武汉",
        Wuxi: "无锡",
        XiAn: "西安",
        Xiamen: "厦门",
        Xingtai: "邢台",
        Xining: "西宁",
        Xuancheng: "宣城",
        Yancheng: "盐城",
        Yangzhou: "扬州",
        Yantai: "烟台",
        Yinchuan: "银川",
        Zaozhuang: "枣庄",
        Zhangjiakou: "张家口",
        Zhengding: "正定",
        Zhengzhou: "郑州",
        Zhenjiang: "镇江",
        Zhoushan: "舟山",
        Zibo: "淄博"
      }
    };
    const adminCities = [
      'Anqing', 'Baoding', 'Beijing', 'Bengbu', 'Binzhou', 'Cangzhou', 'Changchun', 'Changsha',
      'Changzhou', 'Chengde', 'Chengdu', 'Chizhou', 'Chongqing', 'Chuzhou', 'Dalian', 'Dezhou',
      'Dongying', 'Fuyang', 'Fuzhou', 'Guangzhou', 'Guiyang', 'Haikou', 'Handan', 'Hangzhou',
      'Harbin', 'Hefei', 'Hengshui', 'Heze', 'Hohhot', 'HuaiAn', 'Huaibei', 'Huainan', 'Huangshan',
      'Huzhou', 'Jiaxing', 'Jinan', 'Jinhua', 'Kunming', 'Laiwu', 'Langfang', 'Lanzhou', 'Lhasa',
      'Lianyungang', 'Liaocheng', 'Linyi', 'Lishui', 'LuAn', 'MaAnshan', 'Nanchang', 'Nanjing',
      'Nanning', 'Ningbo', 'Qingdao', 'Qinhuangdao', 'Quzhou', 'Rizhao', 'Shanghai', 'Shaoxing',
      'Shenyang', 'Shenzhen', 'Shijiazhuang', 'Suqian', 'Suzhou', 'Taiyuan', 'Taizhou', 'Tangshan',
      'Tianjin', 'Tongling', 'Urumqi', 'Weifang', 'Weihai', 'Wenzhou', 'Wuhan', 'Wuxi', 'XiAn',
      'Xiamen', 'Xingtai', 'Xining', 'Xuancheng', 'Yancheng', 'Yangzhou', 'Yantai', 'Yinchuan',
      'Zaozhuang', 'Zhangjiakou', 'Zhengding', 'Zhengzhou', 'Zhenjiang', 'Zhoushan', 'Zibo'
    ];
    const dealTypes = ['buy', 'rent'];
    const propertyTypes = ['Apartment', 'House', 'Land'];
    const languages = [
      { code: 'EN', name: 'English', flag: '🇬🇧' },
      { code: 'zh', name: '中文', flag: '🇨🇳' }
    ];
    // Generate Cloudinary signature
    function generateSignature(paramsToSign) {
      const timestamp = Math.floor(Date.now() / 1000);
      const params = { ...paramsToSign, timestamp };
      const sortedKeys = Object.keys(params).sort();
      const stringToSign = sortedKeys.map(key => `${key}=${params[key]}`).join('&') + API_SECRET;
      return { signature: CryptoJS.SHA1(stringToSign).toString(CryptoJS.enc.Hex), timestamp };
    }
    // Function to extract public_id from Cloudinary URL
    function getPublicIdFromUrl(url) {
      const match = url.match(/\/upload\/(?:v\d+\/)?(.+)\.\w+$/);
      return match ? match[1] : null;
    }
    // Function to delete image from Cloudinary
    async function deleteFromCloudinary(publicId) {
      const timestamp = Math.floor(Date.now() / 1000);
      const stringToSign = `public_id=${publicId}&timestamp=${timestamp}${API_SECRET}`;
      const signature = CryptoJS.SHA1(stringToSign).toString(CryptoJS.enc.Hex);
      const formData = new FormData();
      formData.append('public_id', publicId);
      formData.append('api_key', API_KEY);
      formData.append('timestamp', timestamp);
      formData.append('signature', signature);
      try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/destroy`, {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        if (result.result === 'ok') {
          console.log('Deleted from Cloudinary:', publicId);
        } else {
          console.error('Delete failed from Cloudinary:', result);
        }
      } catch (error) {
        console.error('Error deleting from Cloudinary:', error);
      }
    }
    // ImageItem component for drag-and-drop
    const ImageItem = ({ image, index, moveImage, removeImage }) => {
      const ref = useRef(null);
      const [{ isDragging }, drag] = useDrag({
        type: 'image',
        item: { index },
        collect: (monitor) => ({
          isDragging: monitor.isDragging(),
        }),
      });
      const [, drop] = useDrop({
        accept: 'image',
        hover(item) {
          if (item.index !== index) {
            moveImage(item.index, index);
            item.index = index;
          }
        },
      });
      drag(drop(ref));
      const handleRemove = () => {
        removeImage(index);
      };
      return h('div', {
        ref,
        className: `flex items-center space-x-2 p-2 bg-gray-100 rounded ${isDragging ? 'opacity-50' : 'opacity-100'} cursor-move`,
      }, [
        h('img', { src: image, alt: `Image ${index + 1}`, className: 'w-16 h-12 object-cover rounded border' }),
        h('span', { className: 'text-gray-600 flex-1 truncate' }, image),
        h('button', {
          type: 'button',
          onClick: handleRemove,
          className: 'bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600'
        }, translations.EN.remove_image),
      ]);
    };
    function AdminPanel() {
      const [lang, setLang] = useState('EN');
      const [formData, setFormData] = useState({
        id: null,
        titleEN: '',
        titleZH: '',
        city: '',
        priceCNY: '',
        priceUSD: '',
        propertyType: 'Apartment',
        dealType: 'buy',
        descriptionEN: '',
        descriptionZH: '',
        area: '',
        rooms: '',
        yearBuilt: '',
        images: [],
        realtor: { name: '', email: '', phone: '' },
      });
      const [isEditing, setIsEditing] = useState(false);
      const [properties, setProperties] = useState([]);
      const t = (key) => translations[lang][key] || key;
      useEffect(() => {
        const savedProperties = JSON.parse(localStorage.getItem('properties')) || [];
        setProperties(savedProperties);
      }, []);
      const handleSubmit = (e) => {
        e.preventDefault();
        const updatedProperties = isEditing
          ? properties.map(p => p.id === formData.id ? formData : p)
          : [...properties, { ...formData, id: properties.length + 1 }];
        localStorage.setItem('properties', JSON.stringify(updatedProperties));
        setProperties(updatedProperties);
        setFormData({ id: null, titleEN: '', titleZH: '', city: '', priceCNY: '', priceUSD: '', propertyType: 'Apartment', dealType: 'buy', descriptionEN: '', descriptionZH: '', area: '', rooms: '', yearBuilt: '', images: [], realtor: { name: '', email: '', phone: '' } });
        setIsEditing(false);
      };
      const handleEdit = (property) => {
        setFormData(property);
        setIsEditing(true);
      };
      const handleDelete = (id) => {
        const updatedProperties = properties.filter(p => p.id !== id);
        localStorage.setItem('properties', JSON.stringify(updatedProperties));
        setProperties(updatedProperties);
      };
      const addImage = () => {
        setFormData(prev => ({ ...prev, images: [...prev.images, ''] }));
      };
      const handleImageChange = (index, value) => {
        const newImages = [...formData.images];
        newImages[index] = value;
        setFormData(prev => ({ ...prev, images: newImages }));
      };
      const removeImage = async (index) => {
        const imageUrl = formData.images[index];
        console.log('Before remove, images:', formData.images);
        setFormData(prev => {
          const newImages = prev.images.filter((_, i) => i !== index);
          console.log('After remove, images:', newImages);
          return { ...prev, images: newImages };
        });
        if (imageUrl.includes('cloudinary.com')) {
          const publicId = getPublicIdFromUrl(imageUrl);
          if (publicId) {
            await deleteFromCloudinary(publicId);
          } else {
            console.error('Could not extract public_id from', imageUrl);
          }
        }
      };
      const moveImage = (fromIndex, toIndex) => {
        const newImages = [...formData.images];
        const [movedImage] = newImages.splice(fromIndex, 1);
        newImages.splice(toIndex, 0, movedImage);
        setFormData(prev => ({ ...prev, images: newImages }));
      };
      return h('div', { className: 'admin-panel' }, [
        h('h2', null, isEditing ? t('edit_property') : t('add_property')),
        h('form', { onSubmit: handleSubmit }, [
          h('input', { name: 'titleEN', value: formData.titleEN, onChange: handleInputChange, placeholder: t('title_en'), required: true }),
          h('input', { name: 'titleZH', value: formData.titleZH, onChange: handleInputChange, placeholder: t('title_zh'), required: true }),
          h('select', { name: 'city', value: formData.city, onChange: handleInputChange, required: true }, [
            h('option', { value: '' }, t('select_city')),
            ...adminCities.map(city => h('option', { key: city, value: city }, t(city) || city))
          ]),
          h('input', { name: 'priceCNY', type: 'number', value: formData.priceCNY, onChange: handleInputChange, placeholder: t('price_cny'), required: true }),
          h('input', { name: 'priceUSD', type: 'number', value: formData.priceUSD, onChange: handleInputChange, placeholder: t('price_usd') }),
          h('select', { name: 'propertyType', value: formData.propertyType, onChange: handleInputChange }, propertyTypes.map(type => h('option', { value: type }, t(type)))),
          h('select', { name: 'dealType', value: formData.dealType, onChange: handleInputChange }, dealTypes.map(type => h('option', { value: type }, t(type)))),
          h('textarea', { name: 'descriptionEN', value: formData.descriptionEN, onChange: handleInputChange, placeholder: t('description_en') }),
          h('textarea', { name: 'descriptionZH', value: formData.descriptionZH, onChange: handleInputChange, placeholder: t('description_zh') }),
          h('input', { name: 'area', type: 'number', value: formData.area, onChange: handleInputChange, placeholder: t('area') }),
          h('input', { name: 'rooms', type: 'number', value: formData.rooms, onChange: handleInputChange, placeholder: t('rooms') }),
          h('input', { name: 'yearBuilt', type: 'number', value: formData.yearBuilt, onChange: handleInputChange, placeholder: t('year_built') }),
          h('div', null, [
            h('button', { type: 'button', onClick: addImage }, t('add_image')),
            h(DndProvider, { backend: HTML5Backend }, [
              h('div', null, formData.images.map((img, index) => h(ImageItem, {
                key: index,
                image: img,
                index,
                moveImage,
                removeImage
              }))),
            ]),
          ]),
          h('input', { name: 'realtor.name', value: formData.realtor.name, onChange: handleInputChange, placeholder: t('realtor_name') }),
          h('input', { name: 'realtor.email', value: formData.realtor.email, onChange: handleInputChange, placeholder: t('realtor_email') }),
          h('input', { name: 'realtor.phone', value: formData.realtor.phone, onChange: handleInputChange, placeholder: t('realtor_phone') }),
          h('button', { type: 'submit' }, isEditing ? t('update') : t('add'))
        ]),
        h('h3', null, t('existing_properties')),
        h('ul', null, properties.map(property => h('li', { key: property.id }, [
          h('span', null, property.titleEN),
          h('button', { onClick: () => handleEdit(property) }, t('edit')),
          h('button', { onClick: () => handleDelete(property.id) }, t('delete'))
        ])))
      ]);
    }
    if (document.getElementById('root')) {
      ReactDOM.render(h(AdminPanel), document.getElementById('root'));
    }
  </script>
</body>
</html>
